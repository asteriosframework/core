#!/usr/bin/php
<?php declare(strict_types=1);

use Asterios\Core\Cli\Builder\ColorBuilder;
use Asterios\Core\Cli\CommandRegistry;

require getcwd() . '/vendor/autoload.php';

$input = $argv[1] ?? 'list';
$argument = $argv[2] ?? null;

handleCommand($input, $argument);

/**
 * @param string $commandName
 * @param string|null $argument
 * @return void
 */
function handleCommand(string $commandName, ?string $argument = null): void
{
    $commandInfo = CommandRegistry::findByNameOrAlias($commandName);
    $colorBuilder = new ColorBuilder();

    if (!$commandInfo)
    {
        echo $colorBuilder->red()
                ->bold()
                ->apply('Unknown command: ') . $colorBuilder->yellow()
                ->bold()
                ->apply($commandName) . PHP_EOL . PHP_EOL;

        $defaultCommand = CommandRegistry::findByNameOrAlias('list');

        if ($defaultCommand)
        {
            $commandList = new $defaultCommand['class'];
            $commandList->handle(null);
        }
        else
        {
            echo $colorBuilder->red()
                    ->bold()
                    ->apply('Failed to load the default ') . $colorBuilder->red()
                    ->yellow()
                    ->apply('list') . $colorBuilder->red()
                    ->bold()
                    ->apply(' command.' . PHP_EOL);
        }

        exit(1);
    }

    $instance = new $commandInfo['class'];
    $instance->handle($argument);
}
