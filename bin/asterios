#!/usr/bin/php
<?php declare(strict_types=1);

use Asterios\Core\Cli\CommandRegistry;

require getcwd() . '/vendor/autoload.php';

$input = $argv[1] ?? 'list';
$argument = $argv[2] ?? null;

handleCommand($input, $argument);

/**
 * @param string $commandName
 * @param string|null $argument
 * @return void
 */
function handleCommand(string $commandName, ?string $argument = null): void
{
    $commandInfo = CommandRegistry::findByNameOrAlias($commandName);

    if (!$commandInfo)
    {
        echo "\033[1;31mUnknown command:\033[0m $commandName\n\n";

        $defaultCommand = CommandRegistry::findByNameOrAlias('list');

        if ($defaultCommand)
        {
            $commandList = new $defaultCommand['class'];
            $commandList->handle(null);
        }
        else
        {
            echo "\033[1;31mFailed to load the default 'list' command.\033[0m\n";
        }

        exit(1);
    }

    if (!function_exists('base_path'))
    {
        function base_path(string $path = ''): string
        {
            return dirname(__DIR__, 3) . ($path ? DIRECTORY_SEPARATOR . $path : '');
        }
    }

    $instance = new $commandInfo['class'];
    $instance->handle($argument);
}
